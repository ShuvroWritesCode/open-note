<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Open Note</title>
  <link rel="stylesheet" href="styles.css">
  <link rel="icon" href="favicon.ico" type="image/x-icon">
  <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
</head>
<body>
  <h1>0pen Note</h1>
  <div class="container">
    <div id="note" contenteditable="true" placeholder="Take note or select text and press Tab+Enter to ask AI"></div>
    <div class="button-container">
      <button id="export" class="button">Get .txt</button>
      <button id="askAI" class="button mobile-only">Ask AI</button>
    </div>
  </div>
  <script>
    const noteElement = document.getElementById('note');
    let tabPressed = false;

    const callAI = async (prompt) => {
      if (!prompt) return;
      
      const thinkingMsgHTML = `<div class="thinking-msg"><span>[Thinking...]</span></div>`;
      noteElement.innerHTML += thinkingMsgHTML;
      noteElement.scrollTop = noteElement.scrollHeight;

      try {
        console.log("Sending request to API with prompt:", prompt);
        const r = await fetch("/api/chat", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({ prompt })
        });
        
        if (!r.ok) {
            const errorData = await r.json().catch(() => ({ message: r.statusText || "Unknown error" }));
            console.error("API request failed:", errorData);
            throw new Error(`API request failed with status ${r.status}: ${errorData.message || 'Unknown error'}`);
        }
        
        const j = await r.json();
        console.log("API response:", j);
        
        // Extract response from the API result
        const aiResponse = j.choices?.[0]?.message?.content || "No response from AI service.";
        console.log("Extracted AI response:", aiResponse);

        noteElement.innerHTML = noteElement.innerHTML.replace(thinkingMsgHTML,
          `<div class="ai-response"><span class="ai-tag">[AI]</span> ${aiResponse.replace(/\n/g, '<br>')}</div>` +
          `<div class="spacer"><br></div>`);
        
        // Set cursor at the end and ensure text color is limegreen for new input
        setTimeout(() => {
          // Create a range at the end of the content
          const range = document.createRange();
          const sel = window.getSelection();
          
          try {
            // Try to move cursor to the end
            range.selectNodeContents(noteElement);
            range.collapse(false); // Collapse to end
            sel.removeAllRanges();
            sel.addRange(range);
            
            // Focus the element
            noteElement.focus();
          } catch (e) {
            console.error("Error setting cursor position:", e);
          }
        }, 50);

      } catch (e) {
        console.error("AI Error:", e);
        noteElement.innerHTML = noteElement.innerHTML.replace(thinkingMsgHTML,
          `<div class="error-msg"><span class="error-tag">[Error]</span> ${e.message}</div>` +
          `<div class="spacer"><br></div>`);
        
        // Set focus after error message
        setTimeout(() => noteElement.focus(), 50);
      }
      noteElement.scrollTop = noteElement.scrollHeight;
    };

    noteElement.addEventListener('keydown', e => {
      if (e.key === 'Tab') {
        e.preventDefault();
        tabPressed = true;
      } else if (e.key === 'Enter' && tabPressed) {
        e.preventDefault();
        const selection = window.getSelection().toString().trim();
        if (selection) callAI(selection);
        tabPressed = false;
      }
    });
    
    noteElement.addEventListener('keyup', e => {
      if (e.key === 'Tab') tabPressed = false;
    });

    // Add event listener for the Ask AI button (for mobile/tablet)
    document.getElementById('askAI').addEventListener('click', () => {
      const selection = window.getSelection().toString().trim();
      if (selection) callAI(selection);
    });

    document.getElementById('export').onclick = () => {
      const text = noteElement.innerText;
      const blob = new Blob([text], { type: 'text/plain' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'Open-Note.txt';
      a.click();
    };
    noteElement.focus();
  </script>
  <script type="module">
    import { inject } from 'https://unpkg.com/@vercel/analytics@1.5.0/dist/index.js';
    inject();
  </script>
</body>
</html>
